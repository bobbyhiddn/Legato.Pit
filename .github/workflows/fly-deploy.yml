name: Fly Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Legato.Pit
    runs-on: ubuntu-latest
    concurrency: deploy-group
    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only

      - name: Verify deployment health
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 15

          APP_URL="https://legato-pit.fly.dev"
          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS..."
            if curl -sf "${APP_URL}/health" > /dev/null 2>&1; then
              echo "Application is healthy!"
              exit 0
            fi
            echo "Waiting 10 seconds..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Warning: Health check did not pass after $MAX_ATTEMPTS attempts"
          echo "Check logs with: fly logs --app legato-pit"
