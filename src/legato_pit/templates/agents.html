{% extends "base.html" %}

{% block title %}Agents - {{ app_name }}{% endblock %}

{% block content %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .page-header h1 {
        margin-bottom: 0.25rem;
    }
    .btn-warning {
        background: #d29922;
        color: #fff;
    }
    .btn-warning:hover {
        background: #e3a82b;
    }
    .agent-note-link {
        color: var(--accent-color);
        text-decoration: none;
    }
    .agent-note-link:hover {
        text-decoration: underline;
    }
    .agent-note-link code {
        color: inherit;
    }
    .badge-chord {
        background: var(--accent-color);
        color: white;
    }
    .badge-multi {
        background: var(--success-color);
        color: white;
    }
    .agent-comments {
        margin-top: 0.75rem;
    }
    .agent-comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .agent-comments-header strong {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .comment-count {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .comment-item {
        padding: 0.6rem 0.75rem;
        background: var(--bg-tertiary, rgba(100, 100, 255, 0.05));
        border-left: 3px solid var(--accent-color);
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .comment-item.comment-claude {
        border-left-color: #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
    }
    .comment-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }
    .comment-author {
        font-weight: 600;
    }
    .comment-text {
        font-size: 0.9rem;
        white-space: pre-wrap;
        margin: 0;
    }
    .add-comment-form {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .add-comment-input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.85rem;
    }
    .add-comment-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .add-comment-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay.active {
        display: flex;
    }
    .modal {
        background: var(--bg-primary);
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0;
        line-height: 1;
    }
    .modal-close:hover {
        color: var(--text-primary);
    }
    .modal-body {
        padding: 1.5rem;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    .form-group {
        margin-bottom: 1.25rem;
    }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.9rem;
    }
    .form-group .hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.9rem;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    select.form-control {
        min-height: 120px;
    }
    .selected-notes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .selected-note-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: var(--accent-color);
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    .selected-note-tag button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        font-size: 1rem;
        line-height: 1;
        opacity: 0.8;
    }
    .selected-note-tag button:hover {
        opacity: 1;
    }
</style>
<div class="agents-container">
    <header class="page-header">
        <div>
            <h1>Chord Queue</h1>
            <p class="subtitle">Review and approve chord repository creation</p>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">+ Create Agent</button>
    </header>

    {% if pending_agents %}
    <section class="card">
        <div class="section-header">
            <h2>Pending Approval</h2>
            <button class="btn btn-danger btn-sm" onclick="rejectAll()">Reject All</button>
        </div>
        <div class="agent-list">
            {% for agent in pending_agents %}
            <div class="agent-item" data-queue-id="{{ agent.queue_id }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        {% set note_count = agent.related_entry_id.split(',') | length if agent.related_entry_id else 0 %}
                        {% if note_count > 1 %}
                        <span class="badge badge-multi">{{ note_count }}-note chord</span>
                        {% else %}
                        <span class="badge badge-chord">chord</span>
                        {% endif %}
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.description %}
                    <p class="agent-desc">{{ agent.description }}</p>
                    {% endif %}
                    {% if agent.related_entry_id %}
                    {% set note_ids = agent.related_entry_id.split(',') %}
                    {% if note_ids | length > 1 %}
                    <span class="agent-source">Linked notes: {{ note_ids | length }} notes from this motif</span>
                    {% else %}
                    <span class="agent-source">Linked note: <a href="{{ url_for('library.view_entry', entry_id=note_ids[0]) }}" class="agent-note-link">{{ agent.related_note_title or note_ids[0] }}</a></span>
                    {% endif %}
                    {% elif agent.source_transcript %}
                    <span class="agent-source">Source: {{ agent.source_transcript }}</span>
                    {% endif %}
                    <span class="agent-date">Queued: {{ agent.created_at[:16] }}</span>
                    <div class="agent-comments" id="comments-section-{{ agent.queue_id }}">
                        <div class="agent-comments-header">
                            <strong>Comments</strong>
                            <span class="comment-count">{{ agent.comments_list | length }}/5</span>
                        </div>
                        <div class="comments-list" id="comments-list-{{ agent.queue_id }}">
                            {% for comment in agent.comments_list %}
                            <div class="comment-item {% if comment.author == 'claude' %}comment-claude{% endif %}">
                                <div class="comment-meta">
                                    <span class="comment-author">{{ comment.author }}</span>
                                    <span class="comment-time">{{ comment.timestamp[:16] if comment.timestamp else '' }}</span>
                                </div>
                                <p class="comment-text">{{ comment.text }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% if agent.comments_list | length < 5 %}
                        <form class="add-comment-form" onsubmit="addComment(event, '{{ agent.queue_id }}')">
                            <input type="text" class="add-comment-input"
                                   id="comment-input-{{ agent.queue_id }}"
                                   placeholder="Add a comment..."
                                   maxlength="500">
                            <button type="submit" class="btn btn-secondary btn-sm add-comment-btn">Add</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="agent-actions">
                    <button class="btn btn-primary" onclick="approveAgent('{{ agent.queue_id }}')">
                        Approve
                    </button>
                    <button class="btn btn-secondary" onclick="rejectAgent('{{ agent.queue_id }}')">
                        Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <section class="card">
        <div class="empty-state-large">
            <p>No chords pending approval</p>
            <span class="empty-hint">When notes are flagged for chord escalation, they'll appear here for review before spawning repositories.</span>
        </div>
    </section>
    {% endif %}

    {% if failed_agents %}
    <section class="card">
        <h2 style="color: #f85149;">Failed Spawns</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">These chords failed to spawn. You may need to <a href="{{ url_for('auth.github_app_login') }}?next=/agents/">re-authenticate with GitHub</a> if your token expired.</p>
        <div class="agent-list">
            {% for agent in failed_agents %}
            <div class="agent-item agent-failed" style="border-left: 3px solid #f85149;">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        <span class="badge" style="background: #f85149; color: white;">spawn_failed</span>
                        <code>{{ agent.project_name }}</code>
                    </span>
                    <span class="agent-error" style="color: #f85149; font-size: 0.85rem;">
                        Error: {{ agent.error }}
                    </span>
                </div>
                <div class="agent-actions">
                    <button class="btn btn-primary" onclick="retrySpawn('{{ agent.queue_id }}', this)">
                        Retry Spawn
                    </button>
                    <button class="btn btn-secondary" onclick="rejectAgent('{{ agent.queue_id }}')">
                        Dismiss
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if recent_agents %}
    <section class="card">
        <h2>Recent Activity</h2>
        <div class="agent-list">
            {% for agent in recent_agents %}
            <div class="agent-item agent-{{ agent.status }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        <span class="badge badge-{{ agent.status }}">{{ agent.status }}</span>
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.approved_by %}
                    <span class="agent-date">{{ agent.status }} by {{ agent.approved_by }} at {{ agent.approved_at[:16] if agent.approved_at else '' }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="card">
        <h2>How It Works</h2>
        <ol class="how-it-works">
            <li>Submit a motif via <a href="{{ url_for('dropbox.index') }}">Motif</a> describing a project idea</li>
            <li>Conduct classifies it as a Note with <code>needs_chord: true</code> and commits to Library</li>
            <li>Pit syncs the Library and detects notes flagged for chord escalation</li>
            <li>Review the chord details and click <strong>Approve</strong> to spawn the repository</li>
            <li>A new repo is created with an initial issue assigned to Copilot</li>
        </ol>
    </section>
</div>

<!-- Create Agent Modal -->
<div class="modal-overlay" id="createAgentModal" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Create Agent</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createAgentForm" onsubmit="submitCreateAgent(event)">
                <div class="form-group">
                    <label for="noteSelect">Select Notes (1-5)</label>
                    <select id="noteSelect" class="form-control" multiple onchange="updateSelectedNotes()">
                        <!-- Populated via JS -->
                    </select>
                    <div class="selected-notes" id="selectedNotesTags"></div>
                    <p class="hint">Hold Ctrl/Cmd to select multiple notes</p>
                </div>

                <div class="form-group">
                    <label for="projectName">Project Name (optional)</label>
                    <input type="text" id="projectName" class="form-control"
                           placeholder="auto-generated from note title if empty"
                           pattern="[a-z0-9-]+" title="Lowercase letters, numbers, and hyphens only">
                    <p class="hint">Slug format: lowercase, hyphens only (e.g., my-project-name)</p>
                </div>

                <div class="form-group">
                    <label for="projectType">Project Type</label>
                    <select id="projectType" class="form-control" style="min-height: auto;">
                        <option value="note">Note (single PR, simple project)</option>
                        <option value="chord">Chord (multi-phase, complex project)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="initialComment">Initial Comment (optional)</label>
                    <textarea id="initialComment" class="form-control" rows="3"
                              placeholder="Additional context, instructions, or requirements..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="submit" form="createAgentForm" class="btn btn-primary" id="createAgentBtn">Create Agent</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function addComment(event, queueId) {
    event.preventDefault();

    const input = document.getElementById(`comment-input-${queueId}`);
    const text = input.value.trim();
    if (!text) return;

    const btn = event.target.querySelector('button');
    btn.disabled = true;
    btn.textContent = 'Adding...';

    try {
        const response = await fetch(`/agents/api/${queueId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });

        const data = await response.json();

        if (data.status === 'added') {
            // Rebuild comments list
            const commentsList = document.getElementById(`comments-list-${queueId}`);
            commentsList.innerHTML = data.comments.map(c => `
                <div class="comment-item ${c.author === 'claude' ? 'comment-claude' : ''}">
                    <div class="comment-meta">
                        <span class="comment-author">${c.author}</span>
                        <span class="comment-time">${c.timestamp ? c.timestamp.slice(0, 16) : ''}</span>
                    </div>
                    <p class="comment-text">${escapeHtml(c.text)}</p>
                </div>
            `).join('');

            // Update count
            const countSpan = document.querySelector(`#comments-section-${queueId} .comment-count`);
            countSpan.textContent = `${data.comments.length}/5`;

            // Clear input or hide form if at limit
            if (data.comments.length >= 5) {
                event.target.remove();
            } else {
                input.value = '';
            }

            showSuccess('Comment added');
        } else {
            showError(data.error || 'Failed to add comment');
        }
    } catch (error) {
        showError(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Add';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function approveAgent(queueId) {
    if (!confirm('Approve this agent? This will spawn a new Lab repository.')) {
        return;
    }

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-primary');
    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
        const response = await fetch(`/agents/api/${queueId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.status === 'approved') {
            showSuccess('Agent approved - spawning repository...');
            item.classList.add('agent-approved');
            item.querySelector('.agent-actions').innerHTML = '<span class="badge badge-approved">Approved - spawning...</span>';
            setTimeout(() => window.location.reload(), 2000);
        } else if (data.needs_reauth) {
            // OAuth token expired - swap Approve button with Re-authenticate button
            showError('GitHub authorization expired. Please re-authenticate to continue.');
            const actionsDiv = item.querySelector('.agent-actions');
            const reauthUrl = (data.reauth_url || '/auth/github-app') + '?next=/agents/';
            actionsDiv.innerHTML = `
                <a href="${reauthUrl}" class="btn btn-warning">Re-authenticate</a>
                <button class="btn btn-secondary" onclick="rejectAgent('${queueId}')">Reject</button>
            `;
        } else {
            showError(data.error || 'Failed to approve');
            btn.disabled = false;
            btn.textContent = 'Approve';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Approve';
    }
}

async function rejectAll() {
    const count = document.querySelectorAll('.agent-item').length;
    if (!confirm(`Reject all ${count} pending agents? This will remove them from the queue and reset linked notes.`)) {
        return;
    }

    try {
        const response = await fetch('/agents/api/reject-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'cleared') {
            showSuccess('All agents rejected');
            window.location.reload();
        } else {
            showError(data.error || 'Failed to reject all');
        }
    } catch (error) {
        showError(error.message);
    }
}

async function rejectAgent(queueId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return;

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-secondary');
    btn.disabled = true;
    btn.textContent = 'Rejecting...';

    try {
        const response = await fetch(`/agents/api/${queueId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.status === 'rejected') {
            showSuccess('Agent rejected');
            item.remove();
            // Check if list is empty
            const list = document.querySelector('.agent-list');
            if (list && list.children.length === 0) {
                window.location.reload();
            }
        } else {
            showError(data.error || 'Failed to reject');
            btn.disabled = false;
            btn.textContent = 'Reject';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Reject';
    }
}

async function retrySpawn(queueId, button) {
    button.disabled = true;
    button.textContent = 'Retrying...';

    try {
        const response = await fetch(`/agents/api/${queueId}/retry`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'spawned') {
            showSuccess('Chord spawned successfully!');
            // Remove the failed item and reload
            setTimeout(() => window.location.reload(), 1500);
        } else if (data.needs_reauth) {
            // OAuth token expired - swap Retry button with Re-authenticate button
            showError('GitHub authorization expired. Please re-authenticate to continue.');
            const reauthUrl = (data.reauth_url || '/auth/github-app') + '?next=/agents/';
            button.outerHTML = `<a href="${reauthUrl}" class="btn btn-warning">Re-authenticate</a>`;
        } else {
            showError(data.error || 'Spawn failed again');
            button.disabled = false;
            button.textContent = 'Retry Spawn';
        }
    } catch (error) {
        showError(error.message);
        button.disabled = false;
        button.textContent = 'Retry Spawn';
    }
}

// ============ Create Agent Modal ============

let availableNotes = [];
let selectedNoteIds = [];

async function openCreateModal() {
    const modal = document.getElementById('createAgentModal');
    modal.classList.add('active');

    // Fetch available notes
    try {
        const response = await fetch('/library/api/entries?limit=100');
        const data = await response.json();
        availableNotes = data.entries || [];

        const select = document.getElementById('noteSelect');
        select.innerHTML = availableNotes.map(note =>
            `<option value="${note.entry_id}">[${note.category}] ${escapeHtml(note.title)}</option>`
        ).join('');

        selectedNoteIds = [];
        updateSelectedNotes();
    } catch (error) {
        showError('Failed to load notes: ' + error.message);
    }
}

function closeCreateModal() {
    const modal = document.getElementById('createAgentModal');
    modal.classList.remove('active');

    // Reset form
    document.getElementById('createAgentForm').reset();
    selectedNoteIds = [];
    updateSelectedNotes();
}

function closeModalOnOverlay(event) {
    if (event.target.classList.contains('modal-overlay')) {
        closeCreateModal();
    }
}

function updateSelectedNotes() {
    const select = document.getElementById('noteSelect');
    selectedNoteIds = Array.from(select.selectedOptions).map(opt => opt.value);

    // Limit to 5
    if (selectedNoteIds.length > 5) {
        selectedNoteIds = selectedNoteIds.slice(0, 5);
        // Deselect extras
        Array.from(select.options).forEach(opt => {
            if (!selectedNoteIds.includes(opt.value)) {
                opt.selected = false;
            }
        });
        showError('Maximum 5 notes allowed');
    }

    // Update tags display
    const tagsContainer = document.getElementById('selectedNotesTags');
    tagsContainer.innerHTML = selectedNoteIds.map(id => {
        const note = availableNotes.find(n => n.entry_id === id);
        const title = note ? note.title : id;
        return `<span class="selected-note-tag">
            ${escapeHtml(title.slice(0, 30))}${title.length > 30 ? '...' : ''}
            <button type="button" onclick="removeSelectedNote('${id}')">&times;</button>
        </span>`;
    }).join('');
}

function removeSelectedNote(noteId) {
    const select = document.getElementById('noteSelect');
    Array.from(select.options).forEach(opt => {
        if (opt.value === noteId) {
            opt.selected = false;
        }
    });
    updateSelectedNotes();
}

async function submitCreateAgent(event) {
    event.preventDefault();

    if (selectedNoteIds.length === 0) {
        showError('Please select at least one note');
        return;
    }

    const btn = document.getElementById('createAgentBtn');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    const projectName = document.getElementById('projectName').value.trim();
    const projectType = document.getElementById('projectType').value;
    const initialComment = document.getElementById('initialComment').value.trim();

    try {
        const response = await fetch('/agents/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                note_ids: selectedNoteIds,
                project_name: projectName || undefined,
                project_type: projectType,
                initial_comment: initialComment || undefined
            })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(`Agent created: ${data.project_name}`);
            closeCreateModal();
            window.location.reload();
        } else {
            showError(data.error || 'Failed to create agent');
        }
    } catch (error) {
        showError(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Agent';
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCreateModal();
    }
});
</script>
{% endblock %}
