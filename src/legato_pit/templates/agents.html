{% extends "base.html" %}

{% block title %}Agents - {{ app_name }}{% endblock %}

{% block content %}
<style>
    .agent-note-link {
        color: var(--accent-color);
        text-decoration: none;
    }
    .agent-note-link:hover {
        text-decoration: underline;
    }
    .agent-note-link code {
        color: inherit;
    }
    .badge-chord {
        background: var(--accent-color);
        color: white;
    }
    .badge-multi {
        background: var(--success-color);
        color: white;
    }
</style>
<div class="agents-container">
    <header class="page-header">
        <h1>Chord Queue</h1>
        <p class="subtitle">Review and approve chord repository creation</p>
    </header>

    {% if pending_agents %}
    <section class="card">
        <div class="section-header">
            <h2>Pending Approval</h2>
            <button class="btn btn-danger btn-sm" onclick="rejectAll()">Reject All</button>
        </div>
        <div class="agent-list">
            {% for agent in pending_agents %}
            <div class="agent-item" data-queue-id="{{ agent.queue_id }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        {% set note_count = agent.related_entry_id.split(',') | length if agent.related_entry_id else 0 %}
                        {% if note_count > 1 %}
                        <span class="badge badge-multi">{{ note_count }}-note chord</span>
                        {% else %}
                        <span class="badge badge-chord">chord</span>
                        {% endif %}
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.description %}
                    <p class="agent-desc">{{ agent.description }}</p>
                    {% endif %}
                    {% if agent.related_entry_id %}
                    {% set note_ids = agent.related_entry_id.split(',') %}
                    {% if note_ids | length > 1 %}
                    <span class="agent-source">Linked notes: {{ note_ids | length }} notes from this transcript</span>
                    {% else %}
                    <span class="agent-source">Linked note: <a href="{{ url_for('library.view_entry', entry_id=note_ids[0]) }}" class="agent-note-link">{{ agent.related_note_title or note_ids[0] }}</a></span>
                    {% endif %}
                    {% elif agent.source_transcript %}
                    <span class="agent-source">Source: {{ agent.source_transcript }}</span>
                    {% endif %}
                    <span class="agent-date">Queued: {{ agent.created_at[:16] }}</span>
                </div>
                <div class="agent-actions">
                    <button class="btn btn-primary" onclick="approveAgent('{{ agent.queue_id }}')">
                        Approve
                    </button>
                    <button class="btn btn-secondary" onclick="rejectAgent('{{ agent.queue_id }}')">
                        Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <section class="card">
        <div class="empty-state-large">
            <p>No chords pending approval</p>
            <span class="empty-hint">When notes are flagged for chord escalation, they'll appear here for review before spawning repositories.</span>
        </div>
    </section>
    {% endif %}

    {% if recent_agents %}
    <section class="card">
        <h2>Recent Activity</h2>
        <div class="agent-list">
            {% for agent in recent_agents %}
            <div class="agent-item agent-{{ agent.status }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        <span class="badge badge-{{ agent.status }}">{{ agent.status }}</span>
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.approved_by %}
                    <span class="agent-date">{{ agent.status }} by {{ agent.approved_by }} at {{ agent.approved_at[:16] if agent.approved_at else '' }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="card">
        <h2>How It Works</h2>
        <ol class="how-it-works">
            <li>Submit a transcript via <a href="{{ url_for('dropbox.index') }}">Dropbox</a> describing a project idea</li>
            <li>Conduct classifies it as a Note with <code>needs_chord: true</code> and commits to Library</li>
            <li>Pit syncs the Library and detects notes flagged for chord escalation</li>
            <li>Review the chord details and click <strong>Approve</strong> to spawn the repository</li>
            <li>A new repo is created with an initial issue assigned to Copilot</li>
        </ol>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
async function approveAgent(queueId) {
    if (!confirm('Approve this agent? This will spawn a new Lab repository.')) {
        return;
    }

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-primary');
    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
        const response = await fetch(`/agents/api/${queueId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'approved') {
            showSuccess('Agent approved - spawning repository...');
            item.classList.add('agent-approved');
            item.querySelector('.agent-actions').innerHTML = '<span class="badge badge-approved">Approved - spawning...</span>';
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showError(data.error || 'Failed to approve');
            btn.disabled = false;
            btn.textContent = 'Approve';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Approve';
    }
}

async function rejectAll() {
    const count = document.querySelectorAll('.agent-item').length;
    if (!confirm(`Reject all ${count} pending agents? This will remove them from the queue and reset linked notes.`)) {
        return;
    }

    try {
        const response = await fetch('/agents/api/reject-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'cleared') {
            showSuccess('All agents rejected');
            window.location.reload();
        } else {
            showError(data.error || 'Failed to reject all');
        }
    } catch (error) {
        showError(error.message);
    }
}

async function rejectAgent(queueId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return;

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-secondary');
    btn.disabled = true;
    btn.textContent = 'Rejecting...';

    try {
        const response = await fetch(`/agents/api/${queueId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.status === 'rejected') {
            showSuccess('Agent rejected');
            item.remove();
            // Check if list is empty
            const list = document.querySelector('.agent-list');
            if (list && list.children.length === 0) {
                window.location.reload();
            }
        } else {
            showError(data.error || 'Failed to reject');
            btn.disabled = false;
            btn.textContent = 'Reject';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Reject';
    }
}
</script>
{% endblock %}
