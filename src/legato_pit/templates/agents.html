{% extends "base.html" %}

{% block title %}Agents - {{ app_name }}{% endblock %}

{% block content %}
<style>
    .agent-note-link {
        color: var(--accent-color);
        text-decoration: none;
    }
    .agent-note-link:hover {
        text-decoration: underline;
    }
    .agent-note-link code {
        color: inherit;
    }
    .badge-chord {
        background: var(--accent-color);
        color: white;
    }
    .badge-multi {
        background: var(--success-color);
        color: white;
    }
    .agent-comments {
        margin-top: 0.75rem;
    }
    .agent-comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .agent-comments-header strong {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .comment-count {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .comment-item {
        padding: 0.6rem 0.75rem;
        background: var(--bg-tertiary, rgba(100, 100, 255, 0.05));
        border-left: 3px solid var(--accent-color);
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .comment-item.comment-claude {
        border-left-color: #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
    }
    .comment-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }
    .comment-author {
        font-weight: 600;
    }
    .comment-text {
        font-size: 0.9rem;
        white-space: pre-wrap;
        margin: 0;
    }
    .add-comment-form {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .add-comment-input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.85rem;
    }
    .add-comment-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .add-comment-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
</style>
<div class="agents-container">
    <header class="page-header">
        <h1>Chord Queue</h1>
        <p class="subtitle">Review and approve chord repository creation</p>
    </header>

    {% if pending_agents %}
    <section class="card">
        <div class="section-header">
            <h2>Pending Approval</h2>
            <button class="btn btn-danger btn-sm" onclick="rejectAll()">Reject All</button>
        </div>
        <div class="agent-list">
            {% for agent in pending_agents %}
            <div class="agent-item" data-queue-id="{{ agent.queue_id }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        {% set note_count = agent.related_entry_id.split(',') | length if agent.related_entry_id else 0 %}
                        {% if note_count > 1 %}
                        <span class="badge badge-multi">{{ note_count }}-note chord</span>
                        {% else %}
                        <span class="badge badge-chord">chord</span>
                        {% endif %}
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.description %}
                    <p class="agent-desc">{{ agent.description }}</p>
                    {% endif %}
                    {% if agent.related_entry_id %}
                    {% set note_ids = agent.related_entry_id.split(',') %}
                    {% if note_ids | length > 1 %}
                    <span class="agent-source">Linked notes: {{ note_ids | length }} notes from this transcript</span>
                    {% else %}
                    <span class="agent-source">Linked note: <a href="{{ url_for('library.view_entry', entry_id=note_ids[0]) }}" class="agent-note-link">{{ agent.related_note_title or note_ids[0] }}</a></span>
                    {% endif %}
                    {% elif agent.source_transcript %}
                    <span class="agent-source">Source: {{ agent.source_transcript }}</span>
                    {% endif %}
                    <span class="agent-date">Queued: {{ agent.created_at[:16] }}</span>
                    <div class="agent-comments" id="comments-section-{{ agent.queue_id }}">
                        <div class="agent-comments-header">
                            <strong>Comments</strong>
                            <span class="comment-count">{{ agent.comments_list | length }}/5</span>
                        </div>
                        <div class="comments-list" id="comments-list-{{ agent.queue_id }}">
                            {% for comment in agent.comments_list %}
                            <div class="comment-item {% if comment.author == 'claude' %}comment-claude{% endif %}">
                                <div class="comment-meta">
                                    <span class="comment-author">{{ comment.author }}</span>
                                    <span class="comment-time">{{ comment.timestamp[:16] if comment.timestamp else '' }}</span>
                                </div>
                                <p class="comment-text">{{ comment.text }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% if agent.comments_list | length < 5 %}
                        <form class="add-comment-form" onsubmit="addComment(event, '{{ agent.queue_id }}')">
                            <input type="text" class="add-comment-input"
                                   id="comment-input-{{ agent.queue_id }}"
                                   placeholder="Add a comment..."
                                   maxlength="500">
                            <button type="submit" class="btn btn-secondary btn-sm add-comment-btn">Add</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="agent-actions">
                    <button class="btn btn-primary" onclick="approveAgent('{{ agent.queue_id }}')">
                        Approve
                    </button>
                    <button class="btn btn-secondary" onclick="rejectAgent('{{ agent.queue_id }}')">
                        Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <section class="card">
        <div class="empty-state-large">
            <p>No chords pending approval</p>
            <span class="empty-hint">When notes are flagged for chord escalation, they'll appear here for review before spawning repositories.</span>
        </div>
    </section>
    {% endif %}

    {% if recent_agents %}
    <section class="card">
        <h2>Recent Activity</h2>
        <div class="agent-list">
            {% for agent in recent_agents %}
            <div class="agent-item agent-{{ agent.status }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        <span class="badge badge-{{ agent.status }}">{{ agent.status }}</span>
                        <code>{{ agent.project_name }}</code>
                    </span>
                    {% if agent.approved_by %}
                    <span class="agent-date">{{ agent.status }} by {{ agent.approved_by }} at {{ agent.approved_at[:16] if agent.approved_at else '' }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="card">
        <h2>How It Works</h2>
        <ol class="how-it-works">
            <li>Submit a motif via <a href="{{ url_for('dropbox.index') }}">Motif</a> describing a project idea</li>
            <li>Conduct classifies it as a Note with <code>needs_chord: true</code> and commits to Library</li>
            <li>Pit syncs the Library and detects notes flagged for chord escalation</li>
            <li>Review the chord details and click <strong>Approve</strong> to spawn the repository</li>
            <li>A new repo is created with an initial issue assigned to Copilot</li>
        </ol>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
async function addComment(event, queueId) {
    event.preventDefault();

    const input = document.getElementById(`comment-input-${queueId}`);
    const text = input.value.trim();
    if (!text) return;

    const btn = event.target.querySelector('button');
    btn.disabled = true;
    btn.textContent = 'Adding...';

    try {
        const response = await fetch(`/agents/api/${queueId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });

        const data = await response.json();

        if (data.status === 'added') {
            // Rebuild comments list
            const commentsList = document.getElementById(`comments-list-${queueId}`);
            commentsList.innerHTML = data.comments.map(c => `
                <div class="comment-item ${c.author === 'claude' ? 'comment-claude' : ''}">
                    <div class="comment-meta">
                        <span class="comment-author">${c.author}</span>
                        <span class="comment-time">${c.timestamp ? c.timestamp.slice(0, 16) : ''}</span>
                    </div>
                    <p class="comment-text">${escapeHtml(c.text)}</p>
                </div>
            `).join('');

            // Update count
            const countSpan = document.querySelector(`#comments-section-${queueId} .comment-count`);
            countSpan.textContent = `${data.comments.length}/5`;

            // Clear input or hide form if at limit
            if (data.comments.length >= 5) {
                event.target.remove();
            } else {
                input.value = '';
            }

            showSuccess('Comment added');
        } else {
            showError(data.error || 'Failed to add comment');
        }
    } catch (error) {
        showError(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Add';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function approveAgent(queueId) {
    if (!confirm('Approve this agent? This will spawn a new Lab repository.')) {
        return;
    }

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-primary');
    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
        const response = await fetch(`/agents/api/${queueId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.status === 'approved') {
            showSuccess('Agent approved - spawning repository...');
            item.classList.add('agent-approved');
            item.querySelector('.agent-actions').innerHTML = '<span class="badge badge-approved">Approved - spawning...</span>';
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showError(data.error || 'Failed to approve');
            btn.disabled = false;
            btn.textContent = 'Approve';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Approve';
    }
}

async function rejectAll() {
    const count = document.querySelectorAll('.agent-item').length;
    if (!confirm(`Reject all ${count} pending agents? This will remove them from the queue and reset linked notes.`)) {
        return;
    }

    try {
        const response = await fetch('/agents/api/reject-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'cleared') {
            showSuccess('All agents rejected');
            window.location.reload();
        } else {
            showError(data.error || 'Failed to reject all');
        }
    } catch (error) {
        showError(error.message);
    }
}

async function rejectAgent(queueId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return;

    const item = document.querySelector(`[data-queue-id="${queueId}"]`);
    const btn = item.querySelector('.btn-secondary');
    btn.disabled = true;
    btn.textContent = 'Rejecting...';

    try {
        const response = await fetch(`/agents/api/${queueId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.status === 'rejected') {
            showSuccess('Agent rejected');
            item.remove();
            // Check if list is empty
            const list = document.querySelector('.agent-list');
            if (list && list.children.length === 0) {
                window.location.reload();
            }
        } else {
            showError(data.error || 'Failed to reject');
            btn.disabled = false;
            btn.textContent = 'Reject';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Reject';
    }
}
</script>
{% endblock %}
