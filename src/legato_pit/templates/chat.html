{% extends "base.html" %}

{% block title %}Chat - {{ app_name }}{% endblock %}

{% block head %}
<style>
    .chat-wrapper {
        display: flex;
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto;
        height: calc(100vh - 200px);
    }

    .chat-sidebar {
        width: 280px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-sidebar.collapsed {
        width: 40px;
    }

    .chat-sidebar.collapsed .sidebar-content {
        display: none;
    }

    .sidebar-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-header h3 {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        font-size: 1rem;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .session-list {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .session-item {
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        background: none;
        text-align: left;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        color: var(--text-primary);
    }

    .session-item:hover {
        background: var(--bg-tertiary);
    }

    .session-item.active {
        background: var(--accent-color);
        color: white;
    }

    .session-title {
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .session-date {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .session-actions {
        display: flex;
        gap: 0.25rem;
        margin-top: 0.25rem;
    }

    .session-delete {
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .session-item:hover .session-delete {
        opacity: 1;
    }

    .session-item.active .session-delete {
        background: rgba(255,255,255,0.2);
    }

    .no-sessions {
        padding: 1rem;
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .chat-container {
        flex: 1;
        max-width: 900px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .chat-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }

    .chat-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        line-height: 1.5;
    }

    .message-user {
        align-self: flex-end;
        background: var(--accent-color);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-assistant {
        align-self: flex-start;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 0.25rem;
    }

    .message-content {
        word-break: break-word;
    }

    .message-user .message-content {
        white-space: pre-wrap;
    }

    /* Markdown styling for assistant messages */
    .message-assistant .message-content p {
        margin: 0 0 0.5em 0;
    }

    .message-assistant .message-content p:last-child {
        margin-bottom: 0;
    }

    .message-assistant .message-content code {
        background: rgba(0,0,0,0.2);
        padding: 0.15em 0.3em;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }

    .message-assistant .message-content pre {
        background: rgba(0,0,0,0.3);
        padding: 0.75em;
        border-radius: 6px;
        overflow-x: auto;
        margin: 0.5em 0;
    }

    .message-assistant .message-content pre code {
        background: none;
        padding: 0;
    }

    .message-assistant .message-content ul,
    .message-assistant .message-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }

    .message-assistant .message-content li {
        margin: 0.25em 0;
    }

    .message-assistant .message-content h1,
    .message-assistant .message-content h2,
    .message-assistant .message-content h3 {
        margin: 0.75em 0 0.5em 0;
        font-size: 1.1em;
    }

    .message-assistant .message-content blockquote {
        border-left: 3px solid var(--accent-color);
        margin: 0.5em 0;
        padding-left: 0.75em;
        opacity: 0.9;
    }

    .message-context {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .context-toggle {
        cursor: pointer;
        text-decoration: underline;
    }

    .context-entries {
        display: none;
        margin-top: 0.5rem;
    }

    .context-entries.show {
        display: block;
    }

    .context-entry {
        padding: 0.25rem 0;
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
        resize: none;
        min-height: 44px;
        max-height: 150px;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .chat-send-btn {
        padding: 0.75rem 1.5rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 1.5rem;
        cursor: pointer;
        font-weight: 500;
    }

    .chat-send-btn:hover {
        opacity: 0.9;
    }

    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .chat-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        gap: 0.5rem;
    }

    .model-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .model-select {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        color: var(--text-primary);
        cursor: pointer;
    }

    .model-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }

    .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 0.75rem 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
    }

    .typing-indicator.show {
        display: flex;
        gap: 0.25rem;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        text-align: center;
        padding: 2rem;
    }

    .empty-chat h2 {
        margin-bottom: 0.5rem;
    }

    .empty-chat p {
        max-width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <!-- Session History Sidebar -->
    <aside class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <h3>History</h3>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebarIcon">&#9664;</span>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="session-list" id="sessionList">
                <div class="no-sessions">Loading sessions...</div>
            </div>
        </div>
    </aside>

    <div class="chat-container">
        <header class="chat-header">
            <h1>Chat with Knowledge Base</h1>
            <div class="chat-stats">
                <span>{{ stats.knowledge_entries }} entries indexed</span>
                <span id="currentModelDisplay">{{ provider }}:{{ model }}</span>
            </div>
        </header>

        <div class="chat-messages" id="chatMessages">
        <div class="empty-chat" id="emptyChat">
            <h2>Start a Conversation</h2>
            <p>Ask questions about your knowledge base. I'll search for relevant context and provide informed answers.</p>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>

    <div class="chat-actions">
        <button type="button" class="btn btn-secondary btn-sm" onclick="newSession()">New Chat</button>
        <div class="model-selector">
            <label for="providerSelect">Provider:</label>
            <select id="providerSelect" class="model-select" onchange="updateModelOptions()">
                <option value="claude" {% if provider == 'claude' %}selected{% endif %}>Claude</option>
                <option value="openai" {% if provider == 'openai' %}selected{% endif %}>OpenAI</option>
            </select>
            <select id="modelSelect" class="model-select">
            </select>
        </div>
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
            <textarea
                class="chat-input"
                id="chatInput"
                placeholder="Ask a question..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button type="submit" class="chat-send-btn" id="sendBtn">Send</button>
        </form>
    </div>
    </div><!-- end chat-container -->
</div><!-- end chat-wrapper -->
{% endblock %}

{% block scripts %}
<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Configure marked for safe rendering
    marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false
    });

    const messagesContainer = document.getElementById('chatMessages');
    const emptyChat = document.getElementById('emptyChat');
    const typingIndicator = document.getElementById('typingIndicator');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const providerSelect = document.getElementById('providerSelect');
    const modelSelect = document.getElementById('modelSelect');

    // Model options per provider (fetched from API)
    let modelOptions = {
        claude: [],
        openai: []
    };

    async function fetchModels() {
        try {
            const response = await fetch('/chat/api/models');
            const data = await response.json();

            if (data.claude) {
                modelOptions.claude = data.claude.map(m => ({
                    value: m.id,
                    label: m.name
                }));
            }
            if (data.openai) {
                modelOptions.openai = data.openai.map(m => ({
                    value: m.id,
                    label: m.name
                }));
            }

            updateModelOptions();
        } catch (error) {
            console.error('Failed to fetch models:', error);
            // Fallback to defaults
            modelOptions = {
                claude: [
                    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
                    { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' },
                ],
                openai: [
                    { value: 'gpt-4o', label: 'GPT-4o' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                ]
            };
            updateModelOptions();
        }
    }

    function updateModelOptions() {
        const provider = providerSelect.value;
        const models = modelOptions[provider] || [];

        modelSelect.innerHTML = models.map(m =>
            `<option value="${m.value}">${m.label}</option>`
        ).join('');

        updateModelDisplay();
    }

    function updateModelDisplay() {
        const displayEl = document.getElementById('currentModelDisplay');
        if (displayEl) {
            displayEl.textContent = `${providerSelect.value}:${modelSelect.value}`;
        }
    }

    // Update display when model changes
    modelSelect.addEventListener('change', updateModelDisplay);

    // Fetch models from API on load
    fetchModels();

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage(event);
        }
    }

    function addMessage(role, content, context = null) {
        emptyChat.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${role}`;

        // Render markdown for assistant messages, escape for user messages
        let renderedContent;
        if (role === 'assistant') {
            renderedContent = marked.parse(content);
        } else {
            renderedContent = escapeHtml(content);
        }

        let html = `<div class="message-content">${renderedContent}</div>`;

        if (context && context.length > 0) {
            const contextId = 'context-' + Date.now();
            html += `
                <div class="message-context">
                    <span class="context-toggle" onclick="toggleContext('${contextId}')">
                        ${context.length} sources used
                    </span>
                    <div class="context-entries" id="${contextId}">
                        ${context.map(c => `
                            <div class="context-entry">
                                ${c.title} (${(c.similarity * 100).toFixed(0)}% match)
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        messageDiv.innerHTML = html;
        messagesContainer.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }

    function toggleContext(id) {
        const el = document.getElementById(id);
        el.classList.toggle('show');
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function sendMessage(event) {
        event.preventDefault();

        const message = chatInput.value.trim();
        if (!message) return;

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Add user message
        addMessage('user', message);

        // Show typing indicator
        typingIndicator.classList.add('show');
        sendBtn.disabled = true;
        scrollToBottom();

        try {
            const response = await fetch('/chat/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message,
                    provider: providerSelect.value,
                    model: modelSelect.value,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                addMessage('assistant', data.response, data.context);
            } else {
                addMessage('assistant', `Error: ${data.error}`);
            }
        } catch (error) {
            addMessage('assistant', `Error: ${error.message}`);
        } finally {
            typingIndicator.classList.remove('show');
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    async function newSession() {
        try {
            await fetch('/chat/api/sessions/new', { method: 'POST' });
            // Clear messages
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(m => m.remove());
            emptyChat.style.display = 'flex';
        } catch (error) {
            console.error('Failed to create new session:', error);
        }
    }

    // Load history on page load
    async function loadHistory() {
        try {
            const response = await fetch('/chat/api/history');
            const data = await response.json();

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content, msg.context);
                });
            }
        } catch (error) {
            console.error('Failed to load history:', error);
        }
    }

    loadHistory();

    // ============ Session Sidebar ============

    const sessionList = document.getElementById('sessionList');
    const chatSidebar = document.getElementById('chatSidebar');
    const sidebarIcon = document.getElementById('sidebarIcon');
    let currentSessionId = null;

    function toggleSidebar() {
        chatSidebar.classList.toggle('collapsed');
        sidebarIcon.innerHTML = chatSidebar.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
    }

    async function loadSessions() {
        try {
            const response = await fetch('/chat/api/sessions');
            const data = await response.json();

            if (data.sessions && data.sessions.length > 0) {
                sessionList.innerHTML = data.sessions.map(s => `
                    <button class="session-item ${s.session_id === currentSessionId ? 'active' : ''}"
                            onclick="switchSession('${s.session_id}')"
                            data-session-id="${s.session_id}">
                        <span class="session-title">${escapeHtml(s.title || 'Untitled Chat')}</span>
                        <span class="session-date">${formatDate(s.updated_at)}</span>
                        <button class="session-delete" onclick="deleteSession(event, '${s.session_id}')" title="Delete">
                            Delete
                        </button>
                    </button>
                `).join('');
            } else {
                sessionList.innerHTML = '<div class="no-sessions">No chat history yet</div>';
            }
        } catch (error) {
            console.error('Failed to load sessions:', error);
            sessionList.innerHTML = '<div class="no-sessions">Failed to load history</div>';
        }
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    async function switchSession(sessionId) {
        if (sessionId === currentSessionId) return;

        try {
            // Update active state in UI
            document.querySelectorAll('.session-item').forEach(el => {
                el.classList.toggle('active', el.dataset.sessionId === sessionId);
            });

            currentSessionId = sessionId;

            // Clear current messages
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(m => m.remove());

            // Load this session's messages
            const response = await fetch(`/chat/api/sessions/${sessionId}/load`, { method: 'POST' });
            if (response.ok) {
                await loadHistory();
            }
        } catch (error) {
            console.error('Failed to switch session:', error);
        }
    }

    async function deleteSession(event, sessionId) {
        event.stopPropagation();
        if (!confirm('Delete this chat session?')) return;

        try {
            const response = await fetch(`/chat/api/sessions/${sessionId}`, { method: 'DELETE' });
            if (response.ok) {
                loadSessions();
                if (sessionId === currentSessionId) {
                    newSession();
                }
            }
        } catch (error) {
            console.error('Failed to delete session:', error);
        }
    }

    // Override newSession to also refresh sidebar
    const originalNewSession = newSession;
    async function newSession() {
        try {
            await fetch('/chat/api/sessions/new', { method: 'POST' });
            currentSessionId = null;
            // Clear messages
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(m => m.remove());
            emptyChat.style.display = 'flex';
            loadSessions();
        } catch (error) {
            console.error('Failed to create new session:', error);
        }
    }

    // Load sessions on page load
    loadSessions();
</script>
{% endblock %}
