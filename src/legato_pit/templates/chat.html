{% extends "base.html" %}

{% block title %}Chat - {{ app_name }}{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .chat-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }

    .chat-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        line-height: 1.5;
    }

    .message-user {
        align-self: flex-end;
        background: var(--accent-color);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-assistant {
        align-self: flex-start;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 0.25rem;
    }

    .message-content {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .message-context {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .context-toggle {
        cursor: pointer;
        text-decoration: underline;
    }

    .context-entries {
        display: none;
        margin-top: 0.5rem;
    }

    .context-entries.show {
        display: block;
    }

    .context-entry {
        padding: 0.25rem 0;
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
        resize: none;
        min-height: 44px;
        max-height: 150px;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .chat-send-btn {
        padding: 0.75rem 1.5rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 1.5rem;
        cursor: pointer;
        font-weight: 500;
    }

    .chat-send-btn:hover {
        opacity: 0.9;
    }

    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .chat-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        gap: 0.5rem;
    }

    .model-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .model-select {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        color: var(--text-primary);
        cursor: pointer;
    }

    .model-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }

    .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 0.75rem 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
    }

    .typing-indicator.show {
        display: flex;
        gap: 0.25rem;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        text-align: center;
        padding: 2rem;
    }

    .empty-chat h2 {
        margin-bottom: 0.5rem;
    }

    .empty-chat p {
        max-width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <header class="chat-header">
        <h1>Chat with Knowledge Base</h1>
        <div class="chat-stats">
            <span>{{ stats.knowledge_entries }} entries indexed</span>
            <span>{{ provider }}:{{ model }}</span>
        </div>
    </header>

    <div class="chat-messages" id="chatMessages">
        <div class="empty-chat" id="emptyChat">
            <h2>Start a Conversation</h2>
            <p>Ask questions about your knowledge base. I'll search for relevant context and provide informed answers.</p>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>

    <div class="chat-actions">
        <button type="button" class="btn btn-secondary btn-sm" onclick="newSession()">New Chat</button>
        <div class="model-selector">
            <label for="providerSelect">Provider:</label>
            <select id="providerSelect" class="model-select" onchange="updateModelOptions()">
                <option value="claude" {% if provider == 'claude' %}selected{% endif %}>Claude</option>
                <option value="openai" {% if provider == 'openai' %}selected{% endif %}>OpenAI</option>
            </select>
            <select id="modelSelect" class="model-select">
            </select>
        </div>
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
            <textarea
                class="chat-input"
                id="chatInput"
                placeholder="Ask a question..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button type="submit" class="chat-send-btn" id="sendBtn">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const messagesContainer = document.getElementById('chatMessages');
    const emptyChat = document.getElementById('emptyChat');
    const typingIndicator = document.getElementById('typingIndicator');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const providerSelect = document.getElementById('providerSelect');
    const modelSelect = document.getElementById('modelSelect');

    // Model options per provider (fetched from API)
    let modelOptions = {
        claude: [],
        openai: []
    };

    async function fetchModels() {
        try {
            const response = await fetch('/chat/api/models');
            const data = await response.json();

            if (data.claude) {
                modelOptions.claude = data.claude.map(m => ({
                    value: m.id,
                    label: m.name
                }));
            }
            if (data.openai) {
                modelOptions.openai = data.openai.map(m => ({
                    value: m.id,
                    label: m.name
                }));
            }

            updateModelOptions();
        } catch (error) {
            console.error('Failed to fetch models:', error);
            // Fallback to defaults
            modelOptions = {
                claude: [
                    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
                    { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' },
                ],
                openai: [
                    { value: 'gpt-4o', label: 'GPT-4o' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                ]
            };
            updateModelOptions();
        }
    }

    function updateModelOptions() {
        const provider = providerSelect.value;
        const models = modelOptions[provider] || [];

        modelSelect.innerHTML = models.map(m =>
            `<option value="${m.value}">${m.label}</option>`
        ).join('');
    }

    // Fetch models from API on load
    fetchModels();

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage(event);
        }
    }

    function addMessage(role, content, context = null) {
        emptyChat.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${role}`;

        let html = `<div class="message-content">${escapeHtml(content)}</div>`;

        if (context && context.length > 0) {
            const contextId = 'context-' + Date.now();
            html += `
                <div class="message-context">
                    <span class="context-toggle" onclick="toggleContext('${contextId}')">
                        ${context.length} sources used
                    </span>
                    <div class="context-entries" id="${contextId}">
                        ${context.map(c => `
                            <div class="context-entry">
                                ${c.title} (${(c.similarity * 100).toFixed(0)}% match)
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        messageDiv.innerHTML = html;
        messagesContainer.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }

    function toggleContext(id) {
        const el = document.getElementById(id);
        el.classList.toggle('show');
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function sendMessage(event) {
        event.preventDefault();

        const message = chatInput.value.trim();
        if (!message) return;

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Add user message
        addMessage('user', message);

        // Show typing indicator
        typingIndicator.classList.add('show');
        sendBtn.disabled = true;
        scrollToBottom();

        try {
            const response = await fetch('/chat/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message,
                    provider: providerSelect.value,
                    model: modelSelect.value,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                addMessage('assistant', data.response, data.context);
            } else {
                addMessage('assistant', `Error: ${data.error}`);
            }
        } catch (error) {
            addMessage('assistant', `Error: ${error.message}`);
        } finally {
            typingIndicator.classList.remove('show');
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    async function newSession() {
        try {
            await fetch('/chat/api/sessions/new', { method: 'POST' });
            // Clear messages
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(m => m.remove());
            emptyChat.style.display = 'flex';
        } catch (error) {
            console.error('Failed to create new session:', error);
        }
    }

    // Load history on page load
    async function loadHistory() {
        try {
            const response = await fetch('/chat/api/history');
            const data = await response.json();

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content, msg.context);
                });
            }
        } catch (error) {
            console.error('Failed to load history:', error);
        }
    }

    loadHistory();
</script>
{% endblock %}
