{% extends "base.html" %}

{% block title %}Chords - {{ app_name }}{% endblock %}

{% block head %}
<style>
    .chord-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-danger {
        background: transparent;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
    }

    .btn-danger:hover {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger-confirm {
        background: var(--danger-color);
        color: white;
        border: 1px solid var(--danger-color);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .cancel-btn {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .chord-card.deleting {
        opacity: 0.5;
        pointer-events: none;
    }

    .delete-warning {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid var(--danger-color);
        border-radius: 4px;
        font-size: 0.875rem;
        color: var(--danger-color);
    }

    .btn-incident {
        background: transparent;
        color: var(--accent-color);
        border: 1px solid var(--accent-color);
    }

    .btn-incident:hover {
        background: var(--accent-color);
        color: white;
    }

    /* Incident Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.95);
        transition: transform 0.2s;
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.5rem;
        line-height: 1;
        padding: 0;
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.9rem;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .modal-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }

    .btn-primary {
        background: var(--accent-color);
        color: white;
        border: none;
    }

    .btn-primary:hover {
        background: var(--accent-hover);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .target-chord-name {
        color: var(--accent-color);
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="chords-container">
    <header class="page-header">
        <h1>Chords</h1>
        <p class="subtitle">Repositories spawned from Notes by LEGATO agents</p>
    </header>

    {% if repos %}
    <section class="card">
        <div class="chords-stats">
            <span class="stat">{{ repos|length }} Chord{{ 's' if repos|length != 1 else '' }}</span>
            <button class="btn btn-small" onclick="window.location.reload()">Refresh</button>
        </div>

        <div class="chords-list">
            {% for repo in repos %}
            <div class="chord-card" data-repo="{{ repo.full_name }}">
                <div class="chord-header">
                    <a href="{{ repo.html_url }}" target="_blank" class="chord-name">
                        {{ repo.name }}
                    </a>
                    <span class="chord-date">{{ repo.created_at[:10] }}</span>
                </div>

                {% if repo.description %}
                <p class="chord-description">{{ repo.description }}</p>
                {% endif %}

                <div class="chord-meta">
                    {% if repo.open_issues_count > 0 %}
                    <span class="badge badge-issues">{{ repo.open_issues_count }} open</span>
                    {% endif %}
                    {% for topic in repo.topics %}
                    <span class="badge badge-topic">{{ topic }}</span>
                    {% endfor %}
                </div>

                <div class="chord-details" id="details-{{ loop.index }}" style="display: none;">
                    <div class="chord-loading">Loading...</div>
                </div>

                <div class="chord-actions">
                    <button class="btn btn-small chord-expand" onclick="toggleDetails('{{ repo.full_name }}', {{ loop.index }})">
                        Show Details
                    </button>
                    <button class="btn btn-small btn-incident"
                            onclick="openIncidentModal('{{ repo.full_name }}', '{{ repo.name }}')">
                        Add Incident
                    </button>
                    <button class="btn btn-small btn-danger delete-btn"
                            id="delete-{{ loop.index }}"
                            onclick="initiateDelete('{{ repo.full_name }}', {{ loop.index }})">
                        Delete
                    </button>
                    <button class="btn btn-small btn-danger-confirm confirm-btn"
                            id="confirm-{{ loop.index }}"
                            style="display: none;"
                            onclick="confirmDelete('{{ repo.full_name }}', {{ loop.index }})">
                        Confirm Delete
                    </button>
                    <button class="btn btn-small cancel-btn"
                            id="cancel-{{ loop.index }}"
                            style="display: none;"
                            onclick="cancelDelete({{ loop.index }})">
                        Cancel
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <section class="card">
        <div class="empty-state-large">
            <p>No Chords found</p>
            <span class="empty-hint">
                Chords are created when you approve agents. They're tagged with 'legato-chord' for tracking.
            </span>
        </div>
    </section>
    {% endif %}

    <section class="card">
        <h2>How Chords Work</h2>
        <ol class="how-it-works">
            <li>A Note (knowledge entry) captures a project idea</li>
            <li>Click "Generate Chord" on the Note, or let Conduct classify it as a project</li>
            <li>Review and approve in the <a href="{{ url_for('agents.index') }}">Agents</a> queue</li>
            <li>A Chord repository is spawned with an initial issue for Copilot</li>
            <li>Track progress here - the Note links back to its Chord</li>
        </ol>
    </section>
</div>

<!-- Incident Modal -->
<div id="incident-modal" class="modal-overlay" onclick="closeIncidentModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>Add Incident to <span id="modal-chord-name" class="target-chord-name"></span></h3>
            <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
        </div>
        <form id="incident-form" onsubmit="submitIncident(event)">
            <input type="hidden" id="incident-repo" value="">
            <div class="form-group">
                <label for="incident-title">Title *</label>
                <input type="text" id="incident-title" placeholder="Brief description of the task" required>
            </div>
            <div class="form-group">
                <label for="incident-description">Description</label>
                <textarea id="incident-description" placeholder="Detailed context, requirements, or instructions for Copilot..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-small cancel-btn" onclick="closeIncidentModal()">Cancel</button>
                <button type="submit" class="btn btn-small btn-primary" id="incident-submit">Create Incident</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const loadedDetails = {};
    let deleteTimeouts = {};

    // ============ Incident Modal Functionality ============

    function openIncidentModal(repoFullName, repoName) {
        document.getElementById('incident-repo').value = repoFullName;
        document.getElementById('modal-chord-name').textContent = repoName;
        document.getElementById('incident-title').value = '';
        document.getElementById('incident-description').value = '';
        document.getElementById('incident-modal').classList.add('active');
        document.getElementById('incident-title').focus();
    }

    function closeIncidentModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('incident-modal').classList.remove('active');
    }

    async function submitIncident(event) {
        event.preventDefault();

        const repo = document.getElementById('incident-repo').value;
        const title = document.getElementById('incident-title').value.trim();
        const description = document.getElementById('incident-description').value.trim();
        const submitBtn = document.getElementById('incident-submit');

        if (!title) {
            showToast('Title is required', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
            const response = await fetch(`/chords/api/repo/${repo}/incident`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, description }),
            });

            const data = await response.json();

            if (response.ok) {
                closeIncidentModal();
                showToast(`Incident created! Issue #${data.issue_number}`, 'success');

                // Refresh the details if they're loaded for this repo
                const card = document.querySelector(`[data-repo="${repo}"]`);
                if (card) {
                    const index = Array.from(document.querySelectorAll('.chord-card')).indexOf(card) + 1;
                    if (loadedDetails[repo]) {
                        delete loadedDetails[repo];
                        await loadRepoDetails(repo, index);
                    }
                    // Update issue count badge
                    const badge = card.querySelector('.badge-issues');
                    if (badge) {
                        const currentCount = parseInt(badge.textContent) || 0;
                        badge.textContent = `${currentCount + 1} open`;
                    } else {
                        const meta = card.querySelector('.chord-meta');
                        if (meta) {
                            const newBadge = document.createElement('span');
                            newBadge.className = 'badge badge-issues';
                            newBadge.textContent = '1 open';
                            meta.insertBefore(newBadge, meta.firstChild);
                        }
                    }
                }
            } else {
                throw new Error(data.error || 'Failed to create incident');
            }

        } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Incident';
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeIncidentModal();
        }
    });

    // ============ Delete Functionality ============

    function initiateDelete(repoName, index) {
        // Show confirm/cancel buttons, hide delete button
        document.getElementById(`delete-${index}`).style.display = 'none';
        document.getElementById(`confirm-${index}`).style.display = 'inline-block';
        document.getElementById(`cancel-${index}`).style.display = 'inline-block';

        // Add warning message
        const card = document.querySelector(`[data-repo="${repoName}"]`);
        if (!card.querySelector('.delete-warning')) {
            const warning = document.createElement('div');
            warning.className = 'delete-warning';
            warning.id = `warning-${index}`;
            warning.innerHTML = '<strong>Warning:</strong> This will permanently delete the GitHub repository. Linked notes will be unlinked (no longer flagged for chord).';
            card.querySelector('.chord-actions').before(warning);
        }

        // Auto-cancel after 10 seconds
        deleteTimeouts[index] = setTimeout(() => cancelDelete(index), 10000);
    }

    function cancelDelete(index) {
        // Clear timeout
        if (deleteTimeouts[index]) {
            clearTimeout(deleteTimeouts[index]);
            delete deleteTimeouts[index];
        }

        // Hide confirm/cancel, show delete
        document.getElementById(`delete-${index}`).style.display = 'inline-block';
        document.getElementById(`confirm-${index}`).style.display = 'none';
        document.getElementById(`cancel-${index}`).style.display = 'none';

        // Remove warning
        const warning = document.getElementById(`warning-${index}`);
        if (warning) warning.remove();
    }

    async function confirmDelete(repoName, index) {
        // Clear timeout
        if (deleteTimeouts[index]) {
            clearTimeout(deleteTimeouts[index]);
            delete deleteTimeouts[index];
        }

        const card = document.querySelector(`[data-repo="${repoName}"]`);
        card.classList.add('deleting');

        // Update button to show progress
        const confirmBtn = document.getElementById(`confirm-${index}`);
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        try {
            const response = await fetch(`/chords/api/repo/${repoName}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                // Success - remove the card with animation
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'translateX(20px)';

                setTimeout(() => {
                    card.remove();

                    // Check if any chords remain
                    const remaining = document.querySelectorAll('.chord-card').length;
                    if (remaining === 0) {
                        location.reload();
                    }
                }, 300);

                // Show success message
                showToast(`Deleted ${repoName.split('/')[1]}. ${data.notes_reset} note(s) reset.`, 'success');
            } else {
                throw new Error(data.error || 'Failed to delete');
            }

        } catch (error) {
            card.classList.remove('deleting');
            confirmBtn.textContent = 'Confirm Delete';
            confirmBtn.disabled = false;
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'error' ? 'var(--danger-color)' : 'var(--accent-color)'};
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ============ Details Functionality ============

    async function toggleDetails(repoName, index) {
        const detailsEl = document.getElementById(`details-${index}`);
        const card = document.querySelector(`[data-repo="${repoName}"]`);
        const btn = card.querySelector('.chord-expand');

        if (detailsEl.style.display === 'none') {
            detailsEl.style.display = 'block';
            btn.textContent = 'Hide Details';

            if (!loadedDetails[repoName]) {
                await loadRepoDetails(repoName, index);
            }
        } else {
            detailsEl.style.display = 'none';
            btn.textContent = 'Show Details';
        }
    }

    async function loadRepoDetails(repoName, index) {
        const detailsEl = document.getElementById(`details-${index}`);

        try {
            const response = await fetch(`/chords/api/repo/${repoName}`);
            const data = await response.json();

            loadedDetails[repoName] = data;

            let html = '';

            // Issues section
            if (data.issues && data.issues.length > 0) {
                html += '<div class="detail-section"><h4>Open Issues</h4><ul class="detail-list">';
                for (const issue of data.issues) {
                    const labels = issue.labels.map(l => `<span class="badge badge-small">${l}</span>`).join(' ');
                    html += `<li>
                        <a href="${issue.html_url}" target="_blank">#${issue.number}: ${issue.title}</a>
                        ${labels}
                        ${issue.assignee ? `<span class="assignee">@${issue.assignee}</span>` : ''}
                    </li>`;
                }
                html += '</ul></div>';
            }

            // PRs section
            if (data.pull_requests && data.pull_requests.length > 0) {
                html += '<div class="detail-section"><h4>Open Pull Requests</h4><ul class="detail-list">';
                for (const pr of data.pull_requests) {
                    const draft = pr.draft ? '<span class="badge badge-draft">Draft</span>' : '';
                    html += `<li>
                        <a href="${pr.html_url}" target="_blank">#${pr.number}: ${pr.title}</a>
                        ${draft}
                        <span class="pr-author">by ${pr.user}</span>
                    </li>`;
                }
                html += '</ul></div>';
            }

            // Recent commits
            if (data.recent_commits && data.recent_commits.length > 0) {
                html += '<div class="detail-section"><h4>Recent Commits</h4><ul class="detail-list commits">';
                for (const commit of data.recent_commits) {
                    html += `<li>
                        <a href="${commit.html_url}" target="_blank"><code>${commit.sha}</code></a>
                        <span class="commit-msg">${commit.message}</span>
                        <span class="commit-author">${commit.author}</span>
                    </li>`;
                }
                html += '</ul></div>';
            }

            if (!html) {
                html = '<p class="empty-state">No activity yet</p>';
            }

            detailsEl.innerHTML = html;

        } catch (error) {
            detailsEl.innerHTML = `<p class="error">Failed to load details: ${error.message}</p>`;
        }
    }
</script>
{% endblock %}
