{% extends "base.html" %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="page-header">
        <h1>LEGATO Dashboard</h1>
        <button class="btn btn-small" onclick="refreshDashboard()">Refresh</button>
    </header>

    <section class="stats-row">
        <div class="stat-card">
            <span class="stat-value">{{ stats.transcripts }}</span>
            <span class="stat-label">Transcripts</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ stats.notes }}</span>
            <span class="stat-label">Notes</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ stats.chords }}</span>
            <span class="stat-label">Chords</span>
        </div>
    </section>

    <section class="card">
        <h2>System Status</h2>
        <div class="status-list">
            {% for status in system_status %}
            <div class="status-item status-{{ status.status }}">
                <span class="status-indicator"></span>
                <span class="status-name">{{ status.name }}</span>
                <span class="status-text">{{ status.text }}</span>
            </div>
            {% endfor %}
        </div>
    </section>

    {% if pending_agents %}
    <section class="card card-highlight">
        <h2>Queued Agents</h2>
        <p class="section-subtitle">Pending approval before spawning Lab repositories</p>
        <div class="agent-list">
            {% for agent in pending_agents %}
            <div class="agent-item" data-queue-id="{{ agent.queue_id }}">
                <div class="agent-info">
                    <span class="agent-title">{{ agent.title }}</span>
                    <span class="agent-meta">
                        <span class="badge badge-{{ agent.project_type }}">{{ agent.project_type }}</span>
                        {{ agent.project_name }}
                        {% if agent.source_transcript %}
                        &middot; from {{ agent.source_transcript }}
                        {% endif %}
                    </span>
                    {% if agent.description %}
                    <span class="agent-desc">{{ agent.description[:100] }}{% if agent.description|length > 100 %}...{% endif %}</span>
                    {% endif %}
                </div>
                <div class="agent-actions">
                    <button class="btn btn-small btn-primary" onclick="approveAgent('{{ agent.queue_id }}')">
                        Approve
                    </button>
                    <button class="btn btn-small btn-secondary" onclick="rejectAgent('{{ agent.queue_id }}')">
                        Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="card">
        <h2>Recent Jobs</h2>
        {% if recent_jobs %}
        <div class="job-list">
            {% for job in recent_jobs %}
            <a href="{{ job.url }}" target="_blank" class="job-item">
                <div class="job-status status-{{ job.status }}">
                    <span class="status-indicator"></span>
                </div>
                <div class="job-info">
                    <span class="job-title">{{ job.title }}</span>
                    <span class="job-meta">{{ job.status_text }} &middot; {{ job.created_at[:10] }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No recent jobs</p>
        {% endif %}
    </section>

    <section class="card">
        <h2>Recent Artifacts</h2>
        {% if recent_artifacts %}
        <div class="artifact-list">
            {% for artifact in recent_artifacts %}
            <div class="artifact-item">
                <span class="artifact-name">{{ artifact.name }}</span>
                <span class="badge badge-{{ artifact.category }}">{{ artifact.category }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No artifacts yet</p>
        {% endif %}
    </section>

    <div class="quick-action">
        <a href="{{ url_for('dropbox.index') }}" class="btn btn-primary btn-large">
            + New Transcript
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshDashboard() {
    window.location.reload();
}

async function approveAgent(queueId) {
    if (!confirm('Approve this agent? This will spawn a new Lab repository.')) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
        const response = await fetch(`/agents/api/${queueId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'approved') {
            showSuccess('Agent approved - spawning repository...');
            const item = document.querySelector(`[data-queue-id="${queueId}"]`);
            item.classList.add('agent-approved');
            item.innerHTML = '<div class="agent-info"><span class="agent-title">Approved - spawning repository...</span></div>';
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showError(data.error || 'Failed to approve');
            btn.disabled = false;
            btn.textContent = 'Approve';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Approve';
    }
}

async function rejectAgent(queueId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return; // Cancelled

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Rejecting...';

    try {
        const response = await fetch(`/agents/api/${queueId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.status === 'rejected') {
            showSuccess('Agent rejected');
            const item = document.querySelector(`[data-queue-id="${queueId}"]`);
            item.remove();
            // If no more agents, remove the section
            const agentList = document.querySelector('.agent-list');
            if (agentList && agentList.children.length === 0) {
                agentList.closest('.card').remove();
            }
        } else {
            showError(data.error || 'Failed to reject');
            btn.disabled = false;
            btn.textContent = 'Reject';
        }
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Reject';
    }
}
</script>
{% endblock %}
