{% extends "base.html" %}

{% block title %}Library - {{ app_name }}{% endblock %}

{% block content %}
<div class="library-container">
    <header class="library-header">
        <div class="header-row">
            <div>
                <h1>Knowledge Library</h1>
                <p class="subtitle">{{ total_knowledge }} entries across {{ categories|length }} categories</p>
            </div>
            <button type="button" class="btn btn-primary" id="embedBtn" onclick="generateEmbeddings()">
                Generate Embeddings
            </button>
        </div>
    </header>

    <div id="statusDiv" class="sync-status" style="display: none;"></div>

    <div class="library-search">
        <form action="{{ url_for('library.search') }}" method="GET" class="search-form">
            <input type="text" name="q" placeholder="Search knowledge base..." class="search-input">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>

    <div class="library-grid">
        <section class="library-section categories-section">
            <h2>Categories</h2>
            <div class="category-list">
                {% for cat in categories %}
                <a href="{{ url_for('library.view_category', category=cat.category) }}" class="category-card">
                    <span class="category-name">{{ cat.category or 'Uncategorized' }}</span>
                    <span class="category-count">{{ cat.count }}</span>
                </a>
                {% else %}
                <p class="empty-state">No categories yet</p>
                {% endfor %}
            </div>
        </section>

        <section class="library-section recent-section">
            <h2>Recent Entries</h2>
            <div class="entry-list">
                {% for entry in recent %}
                <a href="{{ url_for('library.view_entry', entry_id=entry.entry_id) }}" class="entry-card">
                    <span class="entry-title">{{ entry.title }}</span>
                    <span class="entry-meta">
                        <span class="entry-category">{{ entry.category or 'general' }}</span>
                        <span class="entry-date">{{ entry.created_at[:10] }}</span>
                    </span>
                </a>
                {% else %}
                <p class="empty-state">No entries yet</p>
                {% endfor %}
            </div>
        </section>
    </div>

    <div class="library-stats">
        <div class="stat-card">
            <span class="stat-value">{{ total_knowledge }}</span>
            <span class="stat-label">Knowledge Entries</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="embeddingsCount">-</span>
            <span class="stat-label">Embeddings</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ categories|length }}</span>
            <span class="stat-label">Categories</span>
        </div>
    </div>

    {% if total_projects > 0 %}
    <div class="library-actions">
        <a href="{{ url_for('library.list_projects') }}" class="btn btn-secondary">View Projects</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const statusDiv = document.getElementById('statusDiv');

    // Fetch embeddings count on page load
    async function loadStats() {
        try {
            const response = await fetch('/chat/api/stats');
            const data = await response.json();
            document.getElementById('embeddingsCount').textContent = data.embeddings || 0;
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }
    loadStats();

    async function generateEmbeddings() {
        const btn = document.getElementById('embedBtn');

        btn.disabled = true;
        btn.textContent = 'Generating...';
        statusDiv.style.display = 'block';
        statusDiv.className = 'sync-status syncing';
        statusDiv.textContent = 'Generating embeddings for entries...';

        try {
            const response = await fetch('/library/api/generate-embeddings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.status === 'success') {
                statusDiv.className = 'sync-status success';
                statusDiv.textContent = `Generated ${data.embeddings_generated} embeddings.`;
                loadStats();
            } else {
                statusDiv.className = 'sync-status error';
                statusDiv.textContent = `Failed: ${data.error}`;
            }
        } catch (error) {
            statusDiv.className = 'sync-status error';
            statusDiv.textContent = `Failed: ${error.message}`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Embeddings';
        }
    }

</script>
{% endblock %}
