{% extends "base.html" %}

{% block title %}{{ entry.title }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="entry-container">
    <nav class="breadcrumb">
        <a href="{{ url_for('library.index') }}">Library</a>
        <span class="separator">/</span>
        {% if entry.category %}
        <a href="{{ url_for('library.view_category', category=entry.category) }}">{{ entry.category }}</a>
        <span class="separator">/</span>
        {% endif %}
        <span class="current">{{ entry.title }}</span>
    </nav>

    <!-- View Mode -->
    <div id="viewMode">
        <article class="entry-article">
            <header class="entry-header">
                <h1>{{ entry.title }}</h1>
                <div class="entry-meta">
                    {% if entry.category %}
                    <span class="entry-category badge">{{ entry.category }}</span>
                    {% endif %}
                    <span class="entry-date">{{ entry.created_at[:10] }}</span>
                </div>
            </header>

            <details class="entry-metadata">
                <summary>Metadata</summary>
                <dl class="metadata-list">
                    <dt>Entry ID</dt>
                    <dd><code>{{ entry.entry_id }}</code></dd>
                    {% if entry.category %}
                    <dt>Category</dt>
                    <dd>{{ entry.category }}</dd>
                    {% endif %}
                    {% if entry.file_path %}
                    <dt>File Path</dt>
                    <dd><code>{{ entry.file_path }}</code></dd>
                    {% endif %}
                    <dt>Created</dt>
                    <dd>{{ entry.created_at }}</dd>
                    {% if entry.updated_at and entry.updated_at != entry.created_at %}
                    <dt>Updated</dt>
                    <dd>{{ entry.updated_at }}</dd>
                    {% endif %}
                </dl>
            </details>

            <div class="entry-content markdown-body">
                {{ entry.content_html|safe }}
            </div>

            {% if entry.source_thread or entry.source_transcript %}
            <footer class="entry-footer">
                <h3>Source</h3>
                <dl class="source-info">
                    {% if entry.source_transcript %}
                    <dt>Transcript</dt>
                    <dd>{{ entry.source_transcript }}</dd>
                    {% endif %}
                    {% if entry.source_thread %}
                    <dt>Thread</dt>
                    <dd>{{ entry.source_thread }}</dd>
                    {% endif %}
                </dl>
            </footer>
            {% endif %}
        </article>

        <div class="entry-actions">
            {% if entry.file_path %}
            <button type="button" onclick="showEditPane()" class="btn btn-primary">Edit</button>
            {% endif %}
            <button type="button" onclick="generateChord()" class="btn btn-accent" id="chordBtn">
                Generate Chord
            </button>
            <a href="{{ url_for('library.index') }}" class="btn btn-secondary">Back to Library</a>
        </div>
    </div>

    <!-- Edit Mode -->
    <div id="editMode" style="display: none;">
        <header class="entry-header">
            <h1>Editing: {{ entry.title }}</h1>
        </header>

        <div class="edit-pane">
            <textarea id="contentEditor" class="editor-textarea">{{ entry.content }}</textarea>

            <div class="edit-actions">
                <input type="text" id="commitMessage"
                       placeholder="Commit message (e.g., Fix typo, Update section...)"
                       class="form-input">
                <button type="button" onclick="saveEntry()" class="btn btn-primary" id="saveBtn">
                    Save & Commit
                </button>
                <button type="button" onclick="cancelEdit()" class="btn btn-secondary">
                    Cancel
                </button>
            </div>

            <div id="editStatus" class="edit-status" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const entryId = {{ entry.entry_id|tojson }};
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    const contentEditor = document.getElementById('contentEditor');
    const commitMessage = document.getElementById('commitMessage');
    const saveBtn = document.getElementById('saveBtn');
    const editStatus = document.getElementById('editStatus');

    function showEditPane() {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        contentEditor.focus();
    }

    function cancelEdit() {
        editMode.style.display = 'none';
        viewMode.style.display = 'block';
        // Reset content to original
        contentEditor.value = {{ entry.content|tojson }};
        commitMessage.value = '';
        editStatus.style.display = 'none';
    }

    async function saveEntry() {
        const content = contentEditor.value.trim();
        const message = commitMessage.value.trim() || 'Update knowledge entry';

        if (!content) {
            showStatus('Content cannot be empty', 'error');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        showStatus('Committing to GitHub...', 'info');

        try {
            const response = await fetch(`/library/api/entry/${entryId}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, message })
            });

            const data = await response.json();

            if (data.status === 'success') {
                showStatus(`Saved! Commit: ${data.commit_sha.slice(0, 7)}`, 'success');
                // Reload page after short delay to show updated content
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showStatus(`Error: ${data.error}`, 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save & Commit';
            }
        } catch (error) {
            showStatus(`Error: ${error.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Commit';
        }
    }

    function showStatus(message, type) {
        editStatus.textContent = message;
        editStatus.className = `edit-status ${type}`;
        editStatus.style.display = 'block';
    }

    async function generateChord() {
        const scope = prompt('Project scope:\n- note: Single feature, quick implementation\n- chord: Multi-phase, complex project\n\nEnter "note" or "chord":', 'chord');
        if (!scope || (scope !== 'note' && scope !== 'chord')) {
            if (scope !== null) alert('Invalid scope. Please enter "note" or "chord".');
            return;
        }

        const chordBtn = document.getElementById('chordBtn');
        chordBtn.disabled = true;
        chordBtn.textContent = 'Queueing...';

        try {
            const response = await fetch('/agents/api/from-entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    entry_id: entryId,
                    project_scope: scope
                })
            });

            const data = await response.json();

            if (data.status === 'queued') {
                alert(`Queued as agent: ${data.queue_id}\n\nGo to Agents tab to approve.`);
                chordBtn.textContent = 'Queued!';
            } else {
                alert(`Error: ${data.error}`);
                chordBtn.disabled = false;
                chordBtn.textContent = 'Generate Chord';
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
            chordBtn.disabled = false;
            chordBtn.textContent = 'Generate Chord';
        }
    }
</script>
{% endblock %}
