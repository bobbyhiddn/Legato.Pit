{% extends "base.html" %}

{% block title %}Tasks - Library - {{ app_name }}{% endblock %}

{% block head %}
<style>
    .kanban-layout {
        display: flex;
        gap: 1rem;
        max-width: 100%;
        margin: 0;
        padding: 0 1rem;
        min-height: calc(100vh - 120px);
    }

    .kanban-sidebar {
        width: 160px;
        flex-shrink: 0;
        position: sticky;
        top: 70px;
        height: fit-content;
        max-height: calc(100vh - 90px);
        overflow-y: auto;
    }

    .kanban-main {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .sidebar-section {
        margin-bottom: 1.5rem;
    }

    .sidebar-section h3 {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        letter-spacing: 0.05em;
    }

    .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .sidebar-link {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        text-decoration: none;
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: background 0.2s;
        gap: 0.5rem;
    }

    .sidebar-link span:not(.status-dot):not(.sidebar-count) {
        flex: 1;
    }

    .sidebar-link .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .sidebar-link:hover {
        background: var(--bg-tertiary);
    }

    .sidebar-count {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
    }

    /* Kanban Header */
    .kanban-header {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .kanban-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }

    .kanban-header .total-count {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    /* Kanban Board */
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        flex: 1;
        min-height: 400px;
    }

    .kanban-column {
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        border-radius: 8px;
        min-height: 300px;
        max-height: calc(100vh - 180px);
    }

    .column-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid;
        flex-shrink: 0;
    }

    .column-header.status-blocked {
        border-color: var(--danger-color, #dc3545);
    }

    .column-header.status-in_progress {
        border-color: var(--warning-color, #f59e0b);
    }

    .column-header.status-pending {
        border-color: var(--accent-color);
    }

    .column-header.status-done {
        border-color: var(--success-color, #22c55e);
    }

    .column-title {
        font-weight: 600;
        font-size: 0.875rem;
        flex: 1;
    }

    .column-count {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
    }

    .column-body {
        flex: 1;
        padding: 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .column-body.drag-over {
        background: var(--bg-tertiary);
    }

    /* Task Cards */
    .task-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.75rem;
        cursor: grab;
        transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
        position: relative;
    }

    .task-card:hover {
        border-color: var(--accent-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .task-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .task-card.status-done {
        opacity: 0.7;
    }

    .task-header {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .task-link {
        display: block;
        text-decoration: none;
        color: inherit;
        flex: 1;
        min-width: 0;
    }

    .task-title {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-primary);
        word-wrap: break-word;
        line-height: 1.3;
    }

    .task-card.status-done .task-title {
        text-decoration: line-through;
        color: var(--text-secondary);
    }

    .task-link:hover .task-title {
        color: var(--accent-color);
    }

    /* Status dropdown on task cards */
    .task-status-selector {
        position: relative;
        flex-shrink: 0;
    }

    .task-status-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        padding: 0;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .task-status-btn:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .task-status-btn.status-blocked { background: var(--danger-color, #dc3545); }
    .task-status-btn.status-in_progress { background: var(--warning-color, #f59e0b); }
    .task-status-btn.status-pending { background: var(--accent-color); }
    .task-status-btn.status-done { background: var(--success-color, #22c55e); }

    .task-status-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.25rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 200;
        display: none;
        min-width: 140px;
        overflow: hidden;
    }

    .task-status-dropdown.open {
        display: block;
    }

    .task-status-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem 0.75rem;
        text-align: left;
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 0.8rem;
    }

    .task-status-option:hover {
        background: var(--bg-tertiary);
    }

    .task-status-option.current {
        color: var(--accent-color);
        font-weight: 500;
    }

    .task-status-option .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .task-category {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .task-category .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .task-due {
        color: var(--text-secondary);
    }

    .task-due.overdue {
        color: var(--danger-color, #dc3545);
        font-weight: 500;
    }

    .task-due.soon {
        color: var(--warning-color, #f59e0b);
    }

    /* Status dots */
    .dot-blocked { background: var(--danger-color, #dc3545); }
    .dot-in_progress { background: var(--warning-color, #f59e0b); }
    .dot-pending { background: var(--accent-color); }
    .dot-done { background: var(--success-color, #22c55e); }

    /* Empty state */
    .column-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .kanban-board {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .kanban-layout {
            flex-direction: column;
        }

        .kanban-sidebar {
            width: 100%;
            position: static;
            max-height: none;
        }

        .sidebar-nav {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .kanban-board {
            grid-template-columns: 1fr;
        }

        .kanban-column {
            max-height: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="kanban-layout">
    <aside class="kanban-sidebar">
        <div class="sidebar-section">
            <h3>Quick Links</h3>
            <nav class="sidebar-nav">
                <a href="{{ url_for('library.index') }}" class="sidebar-link">
                    <span>Library</span>
                </a>
                <a href="{{ url_for('library.daily_index') }}" class="sidebar-link">
                    <span>Daily View</span>
                </a>
            </nav>
        </div>

        <div class="sidebar-section">
            <h3>Categories</h3>
            <nav class="sidebar-nav">
                {% for cat in categories %}
                <a href="{{ url_for('library.view_category', category=cat.category) }}" class="sidebar-link">
                    <span class="status-dot" style="background: {{ cat.color or '#6366f1' }}"></span>
                    <span>{{ cat.display_name or cat.category }}</span>
                    <span class="sidebar-count">{{ cat.count }}</span>
                </a>
                {% endfor %}
            </nav>
        </div>
    </aside>

    <main class="kanban-main">
        <header class="kanban-header">
            <h1>Tasks</h1>
            <span class="total-count">{{ total_tasks }} task{% if total_tasks != 1 %}s{% endif %}</span>
        </header>

        <div class="kanban-board">
            <!-- Blocked Column -->
            <div class="kanban-column">
                <div class="column-header status-blocked">
                    <span class="status-dot dot-blocked"></span>
                    <span class="column-title">Blocked</span>
                    <span class="column-count">{{ status_counts.get('blocked', 0) }}</span>
                </div>
                <div class="column-body" data-status="blocked"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, 'blocked')">
                    {% for task in tasks_by_status.blocked %}
                    <div class="task-card status-blocked"
                         data-entry-id="{{ task.entry_id }}"
                         data-status="blocked"
                         draggable="true"
                         ondragstart="handleDragStart(event)"
                         ondragend="handleDragEnd(event)">
                        <div class="task-header">
                            <a href="{{ url_for('library.view_entry', entry_id=task.entry_id) }}" class="task-link">
                                <span class="task-title">{{ task.title }}</span>
                            </a>
                            <div class="task-status-selector">
                                <button class="task-status-btn status-blocked" onclick="toggleStatusDropdown(event, '{{ task.entry_id }}')" title="Change status"></button>
                                <div class="task-status-dropdown" id="status-dropdown-{{ task.entry_id }}">
                                    <button class="task-status-option current" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'blocked')">
                                        <span class="status-dot dot-blocked"></span> Blocked
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'in_progress')">
                                        <span class="status-dot dot-in_progress"></span> In Progress
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'pending')">
                                        <span class="status-dot dot-pending"></span> Pending
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'done')">
                                        <span class="status-dot dot-done"></span> Done
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="task-meta">
                            {% if task.category %}
                            <span class="task-category">
                                {% set cat_color = categories | selectattr('category', 'equalto', task.category) | map(attribute='color') | first | default('#6366f1') %}
                                <span class="dot" style="background: {{ cat_color }}"></span>
                                {{ task.category }}
                            </span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="task-due {% if task.due_date < now().strftime('%Y-%m-%d') %}overdue{% elif task.due_date == now().strftime('%Y-%m-%d') %}soon{% endif %}">
                                {{ task.due_date }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="column-empty">No blocked tasks</div>
                    {% endfor %}
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="kanban-column">
                <div class="column-header status-in_progress">
                    <span class="status-dot dot-in_progress"></span>
                    <span class="column-title">In Progress</span>
                    <span class="column-count">{{ status_counts.get('in_progress', 0) }}</span>
                </div>
                <div class="column-body" data-status="in_progress"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, 'in_progress')">
                    {% for task in tasks_by_status.in_progress %}
                    <div class="task-card status-in_progress"
                         data-entry-id="{{ task.entry_id }}"
                         data-status="in_progress"
                         draggable="true"
                         ondragstart="handleDragStart(event)"
                         ondragend="handleDragEnd(event)">
                        <div class="task-header">
                            <a href="{{ url_for('library.view_entry', entry_id=task.entry_id) }}" class="task-link">
                                <span class="task-title">{{ task.title }}</span>
                            </a>
                            <div class="task-status-selector">
                                <button class="task-status-btn status-in_progress" onclick="toggleStatusDropdown(event, '{{ task.entry_id }}')" title="Change status"></button>
                                <div class="task-status-dropdown" id="status-dropdown-{{ task.entry_id }}">
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'blocked')">
                                        <span class="status-dot dot-blocked"></span> Blocked
                                    </button>
                                    <button class="task-status-option current" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'in_progress')">
                                        <span class="status-dot dot-in_progress"></span> In Progress
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'pending')">
                                        <span class="status-dot dot-pending"></span> Pending
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'done')">
                                        <span class="status-dot dot-done"></span> Done
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="task-meta">
                            {% if task.category %}
                            <span class="task-category">
                                {% set cat_color = categories | selectattr('category', 'equalto', task.category) | map(attribute='color') | first | default('#6366f1') %}
                                <span class="dot" style="background: {{ cat_color }}"></span>
                                {{ task.category }}
                            </span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="task-due {% if task.due_date < now().strftime('%Y-%m-%d') %}overdue{% elif task.due_date == now().strftime('%Y-%m-%d') %}soon{% endif %}">
                                {{ task.due_date }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="column-empty">No tasks in progress</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Pending Column -->
            <div class="kanban-column">
                <div class="column-header status-pending">
                    <span class="status-dot dot-pending"></span>
                    <span class="column-title">Pending</span>
                    <span class="column-count">{{ status_counts.get('pending', 0) }}</span>
                </div>
                <div class="column-body" data-status="pending"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, 'pending')">
                    {% for task in tasks_by_status.pending %}
                    <div class="task-card status-pending"
                         data-entry-id="{{ task.entry_id }}"
                         data-status="pending"
                         draggable="true"
                         ondragstart="handleDragStart(event)"
                         ondragend="handleDragEnd(event)">
                        <div class="task-header">
                            <a href="{{ url_for('library.view_entry', entry_id=task.entry_id) }}" class="task-link">
                                <span class="task-title">{{ task.title }}</span>
                            </a>
                            <div class="task-status-selector">
                                <button class="task-status-btn status-pending" onclick="toggleStatusDropdown(event, '{{ task.entry_id }}')" title="Change status"></button>
                                <div class="task-status-dropdown" id="status-dropdown-{{ task.entry_id }}">
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'blocked')">
                                        <span class="status-dot dot-blocked"></span> Blocked
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'in_progress')">
                                        <span class="status-dot dot-in_progress"></span> In Progress
                                    </button>
                                    <button class="task-status-option current" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'pending')">
                                        <span class="status-dot dot-pending"></span> Pending
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'done')">
                                        <span class="status-dot dot-done"></span> Done
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="task-meta">
                            {% if task.category %}
                            <span class="task-category">
                                {% set cat_color = categories | selectattr('category', 'equalto', task.category) | map(attribute='color') | first | default('#6366f1') %}
                                <span class="dot" style="background: {{ cat_color }}"></span>
                                {{ task.category }}
                            </span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="task-due {% if task.due_date < now().strftime('%Y-%m-%d') %}overdue{% elif task.due_date == now().strftime('%Y-%m-%d') %}soon{% endif %}">
                                {{ task.due_date }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="column-empty">No pending tasks</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Done Column -->
            <div class="kanban-column">
                <div class="column-header status-done">
                    <span class="status-dot dot-done"></span>
                    <span class="column-title">Done</span>
                    <span class="column-count">{{ status_counts.get('done', 0) }}</span>
                </div>
                <div class="column-body" data-status="done"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, 'done')">
                    {% for task in tasks_by_status.done %}
                    <div class="task-card status-done"
                         data-entry-id="{{ task.entry_id }}"
                         data-status="done"
                         draggable="true"
                         ondragstart="handleDragStart(event)"
                         ondragend="handleDragEnd(event)">
                        <div class="task-header">
                            <a href="{{ url_for('library.view_entry', entry_id=task.entry_id) }}" class="task-link">
                                <span class="task-title">{{ task.title }}</span>
                            </a>
                            <div class="task-status-selector">
                                <button class="task-status-btn status-done" onclick="toggleStatusDropdown(event, '{{ task.entry_id }}')" title="Change status"></button>
                                <div class="task-status-dropdown" id="status-dropdown-{{ task.entry_id }}">
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'blocked')">
                                        <span class="status-dot dot-blocked"></span> Blocked
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'in_progress')">
                                        <span class="status-dot dot-in_progress"></span> In Progress
                                    </button>
                                    <button class="task-status-option" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'pending')">
                                        <span class="status-dot dot-pending"></span> Pending
                                    </button>
                                    <button class="task-status-option current" onclick="changeTaskStatus(event, '{{ task.entry_id }}', 'done')">
                                        <span class="status-dot dot-done"></span> Done
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="task-meta">
                            {% if task.category %}
                            <span class="task-category">
                                {% set cat_color = categories | selectattr('category', 'equalto', task.category) | map(attribute='color') | first | default('#6366f1') %}
                                <span class="dot" style="background: {{ cat_color }}"></span>
                                {{ task.category }}
                            </span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="task-due">
                                {{ task.due_date }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="column-empty">No completed tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    let draggedCard = null;

    function handleDragStart(event) {
        draggedCard = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', event.target.dataset.entryId);
    }

    function handleDragEnd(event) {
        event.target.classList.remove('dragging');
        draggedCard = null;
        // Remove drag-over class from all columns
        document.querySelectorAll('.column-body').forEach(col => {
            col.classList.remove('drag-over');
        });
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
        event.currentTarget.classList.remove('drag-over');
    }

    async function handleDrop(event, newStatus) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');

        if (!draggedCard) return;

        const entryId = draggedCard.dataset.entryId;
        const oldStatus = draggedCard.className.match(/status-(\w+)/)?.[1];

        if (oldStatus === newStatus) return;

        // Optimistically move the card
        const targetColumn = event.currentTarget;
        const emptyState = targetColumn.querySelector('.column-empty');
        if (emptyState) {
            emptyState.remove();
        }
        targetColumn.appendChild(draggedCard);

        // Update card styling
        draggedCard.className = draggedCard.className.replace(/status-\w+/g, '');
        draggedCard.classList.add('task-card', `status-${newStatus}`);

        // Check if old column is now empty
        const oldColumn = document.querySelector(`.column-body[data-status="${oldStatus}"]`);
        if (oldColumn && oldColumn.querySelectorAll('.task-card').length === 0) {
            const statusLabels = {
                'blocked': 'No blocked tasks',
                'in_progress': 'No tasks in progress',
                'pending': 'No pending tasks',
                'done': 'No completed tasks'
            };
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'column-empty';
            emptyDiv.textContent = statusLabels[oldStatus];
            oldColumn.appendChild(emptyDiv);
        }

        // Update counts
        updateColumnCounts();

        // Send update to server
        try {
            const response = await fetch(`/library/api/task/${entryId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                showSuccess(`Task moved to "${formatStatus(newStatus)}"`);
            } else {
                showError(data.error || 'Failed to update task');
                // Reload on failure to reset state
                window.location.reload();
            }
        } catch (error) {
            showError(error.message);
            window.location.reload();
        }
    }

    function updateColumnCounts() {
        document.querySelectorAll('.column-body').forEach(column => {
            const status = column.dataset.status;
            const count = column.querySelectorAll('.task-card').length;
            const countEl = column.previousElementSibling.querySelector('.column-count');
            if (countEl) {
                countEl.textContent = count;
            }
        });

        // Update total count
        const totalCards = document.querySelectorAll('.task-card').length;
        const totalEl = document.querySelector('.total-count');
        if (totalEl) {
            totalEl.textContent = `${totalCards} task${totalCards !== 1 ? 's' : ''}`;
        }
    }

    function formatStatus(status) {
        const labels = {
            'blocked': 'Blocked',
            'in_progress': 'In Progress',
            'pending': 'Pending',
            'done': 'Done'
        };
        return labels[status] || status;
    }

    // Status dropdown functions
    function toggleStatusDropdown(event, entryId) {
        event.preventDefault();
        event.stopPropagation();

        // Close all other dropdowns
        document.querySelectorAll('.task-status-dropdown.open').forEach(d => {
            if (d.id !== `status-dropdown-${entryId}`) {
                d.classList.remove('open');
            }
        });

        const dropdown = document.getElementById(`status-dropdown-${entryId}`);
        dropdown.classList.toggle('open');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.task-status-selector')) {
            document.querySelectorAll('.task-status-dropdown.open').forEach(d => {
                d.classList.remove('open');
            });
        }
    });

    async function changeTaskStatus(event, entryId, newStatus) {
        event.preventDefault();
        event.stopPropagation();

        // Close dropdown
        document.querySelectorAll('.task-status-dropdown.open').forEach(d => {
            d.classList.remove('open');
        });

        const card = document.querySelector(`.task-card[data-entry-id="${entryId}"]`);
        if (!card) return;

        const oldStatus = card.dataset.status;
        if (oldStatus === newStatus) return;

        // Optimistically move the card
        const targetColumn = document.querySelector(`.column-body[data-status="${newStatus}"]`);
        const emptyState = targetColumn.querySelector('.column-empty');
        if (emptyState) {
            emptyState.remove();
        }
        targetColumn.appendChild(card);

        // Update card data and styling
        card.dataset.status = newStatus;
        card.className = card.className.replace(/status-\w+/g, '');
        card.classList.add('task-card', `status-${newStatus}`);

        // Update the status button
        const statusBtn = card.querySelector('.task-status-btn');
        statusBtn.className = `task-status-btn status-${newStatus}`;

        // Update current marker in dropdown
        const dropdown = card.querySelector('.task-status-dropdown');
        dropdown.querySelectorAll('.task-status-option').forEach(opt => {
            opt.classList.remove('current');
            if (opt.textContent.toLowerCase().includes(newStatus.replace('_', ' '))) {
                opt.classList.add('current');
            }
        });

        // Check if old column is now empty
        const oldColumn = document.querySelector(`.column-body[data-status="${oldStatus}"]`);
        if (oldColumn && oldColumn.querySelectorAll('.task-card').length === 0) {
            const statusLabels = {
                'blocked': 'No blocked tasks',
                'in_progress': 'No tasks in progress',
                'pending': 'No pending tasks',
                'done': 'No completed tasks'
            };
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'column-empty';
            emptyDiv.textContent = statusLabels[oldStatus];
            oldColumn.appendChild(emptyDiv);
        }

        // Update counts
        updateColumnCounts();

        // Send update to server
        try {
            const response = await fetch(`/library/api/task/${entryId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                showSuccess(`Status changed to "${formatStatus(newStatus)}"`);
            } else {
                showError(data.error || 'Failed to update status');
                window.location.reload();
            }
        } catch (error) {
            showError(error.message);
            window.location.reload();
        }
    }
</script>
{% endblock %}
